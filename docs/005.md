# Zotero2Readwise 架构与数据流（基于上游实现解析）

参考上游项目仓库：[`e-alizadeh/Zotero2Readwise`](https://github.com/e-alizadeh/Zotero2Readwise.git)

---

## 1. 项目组织结构（关键文件）
- `zotero2readwise/zt2rw.py`：整体编排入口（管道类 `Zotero2Readwise`），串联 Zotero 抓取与 Readwise 上传。
- `zotero2readwise/zotero.py`：Zotero 侧数据访问与结构化（`pyzotero.Zotero` 客户端、`ZoteroItem` 数据结构、格式化与过滤）。
- `zotero2readwise/readwise.py`：Readwise 适配层（高亮数据模型 `ReadwiseHighlight`、批量创建接口）。
- `zotero2readwise/run.py`：命令行入口（参数解析、增量“since”控制）。
- `zotero2readwise/helper.py`：辅助函数（标签清洗、读取/写入库版本“since”）。
- `zotero2readwise/exception.py`：自定义异常定义。

---

## 2. 端到端流程概览
1) 初始化：创建 `Readwise` 与 `pyzotero.Zotero` 客户端，并构造 `ZoteroAnnotationsNotes` 格式化器。
2) 抓取：按需抓取 `annotation`（高亮/批注）与 `note`（笔记），支持 `since` 增量。
3) 格式化：将 Zotero 原始项映射为内部 `ZoteroItem`，可按颜色/标签过滤。
4) 转换：将 `ZoteroItem` 转换为 `ReadwiseHighlight`（Readwise 上传模板），合并标签与注释为备注，生成深链 `highlight_url`。
5) 批量上传：一次性 POST 到 Readwise `/highlights/`，失败项记录与导出。

代码锚点：
```57:89:Zotero2Readwise/zotero2readwise/zt2rw.py
    def run(self, zot_annots_notes: List[Dict] = None) -> None:
        if zot_annots_notes is None:
            zot_annots_notes = self.get_all_zotero_items()

        formatted_items = self.zotero.format_items(zot_annots_notes)
        if self.write_failures and self.zotero.failed_items:
            self.zotero.save_failed_items_to_json("failed_zotero_items.json")
        self.readwise.post_zotero_annotations_to_readwise(formatted_items)

    def retrieve_all(self, item_type: str, since: int = 0):
        if item_type not in ["annotation", "note"]:
            raise ValueError(...)
        query = self.zotero_client.items(itemType=item_type, since=since)
        return self.zotero_client.everything(query)
```

---

## 3. 获取 Zotero 高亮/笔记
- 客户端：`pyzotero.Zotero`（通过 `get_zotero_client` 构造）。
- 抓取接口：`items(itemType=..., since=...)` + `everything(...)` 拉取全部结果。
- 支持类型：`annotation` 与 `note`。
- 不支持：手写/图像类注释（`annotationType` 非 `highlight`/`note` 时抛出 `NotImplementedError`）。

代码锚点：
```126:171:Zotero2Readwise/zotero2readwise/zotero.py
class ZoteroAnnotationsNotes:
    ...
    def get_item_metadata(self, annot: Dict) -> Dict:
        ...  # 解析父项/顶层项、标题、作者、标签、源码链接、PDF 附件链接
```
```188:211:Zotero2Readwise/zotero2readwise/zotero.py
    def format_item(self, annot: Dict) -> ZoteroItem:
        ...
        if item_type == "annotation":
            if annotation_type == "highlight":
                text = data["annotationText"]
                comment = data["annotationComment"]
            elif annotation_type == "note":
                text = data["annotationComment"]
                comment = ""
            else:
                raise NotImplementedError("Handwritten annotations are not currently supported.")
        elif item_type == "note":
            text = data["note"]
            comment = ""
```

---

## 4. 汇总与字段映射（Zotero → 内部模型）
- 结构体：`ZoteroItem`，包含 `text/title/tags/document_tags/document_type/creators/source_url/attachment_url/page_label/color/...`。
- 元数据：通过父项与顶层项映射获取 `title/tags/document_type/source_url/creators/attachment_url`；作者名做裁剪拼接（防止过长）。
- 过滤：
  - 颜色：`--filter_color`（支持 8 种十六进制颜色）。
  - 标签：`--filter_tags` 排除/保留；`--include_filter_tags` 控制是否把过滤标签并入高亮备注。

代码锚点：
```11:31:Zotero2Readwise/zotero2readwise/zotero.py
@dataclass
class ZoteroItem:
    key: str
    version: int
    item_type: str
    text: str
    annotated_at: str
    annotation_url: str
    ...
```
```248:277:Zotero2Readwise/zotero2readwise/zotero.py
    def format_items(self, annots: List[Dict]) -> List[ZoteroItem]:
        ...  # 颜色/标签过滤，失败项入 self.failed_items
```

---

## 5. 上传到 Readwise（批量）
- 接口：`POST https://readwise.io/api/v2/highlights/`，Header：`Authorization: Token <token>`。
- 批量：一次性发送 `{"highlights": [ ... ]}`。
- 失败：非 200 会将响应 JSON 写入 `error_log_<status>_failed_post_request_to_readwise.json` 并抛异常。

代码锚点：
```60:76:Zotero2Readwise/zotero2readwise/readwise.py
    def create_highlights(self, highlights: List[Dict]) -> None:
        resp = requests.post(...)
        if resp.status_code != 200:
            with open(error_log_file, "w") as f:
                dump(resp.json(), f)
            raise Zotero2ReadwiseError(...)
```
```123:151:Zotero2Readwise/zotero2readwise/readwise.py
    def post_zotero_annotations_to_readwise(...):
        ...  # 拼装 rw_highlights，长度>8191 跳过并记录失败
        self.create_highlights(rw_highlights)
```

---

## 6. 上传模板（ReadwiseHighlight）
- 数据类字段：`text/title/author/image_url/source_url/source_type/category/note/location/location_type/highlighted_at/highlight_url`。
- 实际上传前会剔除空值（`get_nonempty_params()`）。
- 标签写入：将 Zotero 标签转为 `.tag` 形式并与注释合并为 `note` 的首行。
- 页面位置：若 `page_label` 为数字则作为 `location`（`location_type=page`）。
- 深链：
  - 若存在 PDF `attachment_url`，构造 `zotero://open-pdf/library/items/<attachment_id>?page=<page>%&annotation=<annot_id>`；
  - 否则回退为 Zotero 提供的 `annotation_url`。

代码锚点：
```30:52:Zotero2Readwise/zotero2readwise/readwise.py
@dataclass
class ReadwiseHighlight:
    text: str
    title: Optional[str] = None
    author: Optional[str] = None
    image_url: Optional[str] = None
    ...
```
```91:121:Zotero2Readwise/zotero2readwise/readwise.py
    def convert_zotero_annotation_to_readwise_highlight(...):
        ...  # 标签转 .tag，加注释；category 依文献类型；highlight_url 深链或 annotation_url
```

示例（精简）：
```json
{
  "highlights": [
    {
      "text": "选中文本...",
      "title": "文献标题",
      "author": "作者1, 作者2",
      "note": ".tag1 .tag2\n批注内容",
      "category": "articles",
      "source_url": "https://...",
      "highlight_url": "zotero://open-pdf/library/items/ABC?page=10%&annotation=DEF",
      "location": 10,
      "location_type": "page",
      "highlighted_at": "2024-01-01T00:00:00Z"
    }
  ]
}
```

---

## 7. 图片/手写注释处理
- 目前未支持“手写/图像类”注释（`annotationType` 非 `highlight`/`note` 将抛出异常）。
- `ReadwiseHighlight.image_url` 字段在当前转换流程中未填充；仅通过 `attachment_url` 构造深链，未做图片内容上传。

---

## 8. 增量与避免重复
- 增量：
  - CLI 提供 `--use_since`，读取上次 `zotero_client.last_modified_version()` 写入到工作目录 `since` 文件；
  - 下次运行时传入 `since` 实现“只取变化”。
- 去重：
  - 本地未做显式去重；依赖 Readwise 侧以 `highlight_url` 等进行合并更新（上游 README 的承诺）。
  - 结合 `--use_since` 可减少重复抓取与上传。

代码锚点：
```21:46:Zotero2Readwise/zotero2readwise/helper.py
def read_library_version(): ...
def write_library_version(zotero_client): ...  # 写入 last_modified_version()
```
```80:97:Zotero2Readwise/zotero2readwise/run.py
since = read_library_version() if args["use_since"] else 0
...
if args["use_since"]:
    write_library_version(zt2rw.zotero_client)
```

---

## 9. 网络错误与重传
- 上传失败处理：
  - 批量 POST 非 200：保存错误响应为 `error_log_<status>_failed_post_request_to_readwise.json` 并抛异常；
  - 转换失败或超长（>8191 字符）：加入 `failed_highlights`，可调用 `save_failed_items_to_json()` 导出列表。
- 自动重试：当前未内置退避/重试逻辑；建议在外层运行器（CI/定时任务）增加重试与告警，或为 `create_highlights` 包一层重试装饰器（指数退避、处理 429/5xx）。

代码锚点：
```151:174:Zotero2Readwise/zotero2readwise/readwise.py
def save_failed_items_to_json(...): ...  # 导出失败项
```

---

## 10. 命令行与参数（常用）
- 基本：`python run.py <readwise_token> <zotero_key> <zotero_library_id>`
- 选项：
  - `--library_type user|group`
  - `--include_annotations y|n`、`--include_notes y|n`
  - `--filter_color <hex>`（可多次）
  - `--filter_tags <tag>`（可多次）、`--include_filter_tags`
  - `--use_since`（开启增量）、`--suppress_failures`（不生成失败项文件）

---

## 11. 已知限制与注意
- 高亮/备注长度限制：单条 Readwise highlight 最长 8191 字符，超出将被跳过并记录失败。
- 图片/手写注释：暂不支持。
- 速率限制/重试：当前未内置自动重试与速率限制处理，建议由外层调度保障。

---

以上内容基于上游实现与仓库文档整理（仓库链接：[`e-alizadeh/Zotero2Readwise`](https://github.com/e-alizadeh/Zotero2Readwise.git)）。